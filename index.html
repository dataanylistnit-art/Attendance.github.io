<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Attendance Management System</title>
  <style>
    /* Your existing CSS - unchanged */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 1200px;
      min-height: 600px;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .nav-tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }

    .nav-tab {
      flex: 1;
      padding: 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .nav-tab.active {
      background: white;
      border-bottom: 3px solid #4facfe;
      color: #4facfe;
      font-weight: bold;
    }

    .tab-content {
      padding: 30px;
      min-height: 500px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    .login-form {
      max-width: 400px;
      margin: 0 auto;
      padding: 40px;
      background: #f8f9fa;
      border-radius: 15px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #4facfe;
    }

    .btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #06d6a0 0%, #118a7e 100%);
    }

    .attendance-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      margin-bottom: 30px;
    }

    .time-display {
      font-size: 48px;
      font-weight: bold;
      color: #4facfe;
      margin-bottom: 20px;
    }

    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin: 5px;
    }

    .status.checked-in {
      background: #d4edda;
      color: #155724;
    }

    .status.checked-out {
      background: #f8d7da;
      color: #721c24;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .records-table th {
      background: #4facfe;
      color: white;
      padding: 15px;
      text-align: left;
    }

    .records-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .records-table tr:hover {
      background: #f8f9fa;
    }

    .location-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #4facfe;
    }

    .stat-label {
      color: #666;
      margin-top: 10px;
    }

    .hidden {
      display: none !important;
    }

    .alert {
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      font-weight: bold;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    @media (max-width: 768px) {
      .container {
        width: 95%;
        margin: 10px;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .dashboard-stats {
        grid-template-columns: 1fr;
      }

      .time-display {
        font-size: 36px;
      }
    }

    /* Admin specific styles */
    .admin-section {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 15px;
      margin-top: 20px;
    }
    .admin-section h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .admin-section .form-group {
      margin-bottom: 15px;
    }
    .admin-section .btn {
      margin-right: 10px;
    }
    .admin-table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Rest of your existing HTML structure (login, mainApp, tabs) remains exactly same -->

    <!-- For brevity, not repeating entire HTML markup, retain your existing HTML -->
  </div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbzeNw-5zgdAPwYzO0dQGzzYFHsBW6AgVomZVH_6upMe1SnqKkSkI6MhUGfLS1hAIzGD/exec';

  let currentEmployee = null;
  let userLocation = null;

  async function callApi(action, data = {}) {
    data.action = action;
    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      return await response.json();
    } catch (error) {
      console.error('API call failed:', error);
      return null;
    }
  }

  async function login() {
    const empId = document.getElementById('employeeId').value.toUpperCase();
    const password = document.getElementById('password').value;
    const messageDiv = document.getElementById('loginMessage');

    if (!empId || !password) {
      messageDiv.innerHTML = '<div class="alert alert-error">Please enter both ID and Password</div>';
      return;
    }

    const result = await callApi('login', { id: empId, password });
    if (result && result.success) {
      currentEmployee = empId;
      document.getElementById('employeeName').textContent = result.name;
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      if (result.isAdmin) {
        document.getElementById('adminTab').classList.remove('hidden');
      } else {
        document.getElementById('adminTab').classList.add('hidden');
      }
      await updateDashboard();
      messageDiv.innerHTML = '';
    } else {
      messageDiv.innerHTML = `<div class="alert alert-error">${result?.message || 'Invalid Credentials'}</div>`;
    }
  }

  async function updateDashboard() {
    if (!currentEmployee) return;

    const attendanceRes = await callApi('getAttendance', { empId: currentEmployee });
    const leaveRes = await callApi('getLeave', { empId: currentEmployee });
    if (!attendanceRes || !attendanceRes.success || !leaveRes || !leaveRes.success) {
      console.error('Failed to load attendance or leave data');
      return;
    }
    const attendanceData = attendanceRes.attendance;
    const leaveData = leaveRes.leave;

    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    let presentDays = 0,
      lateMarks = 0,
      halfDays = 0,
      leaveDaysCount = 0;

    attendanceData.forEach((record) => {
      const recordDate = new Date(record.date);
      if (recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear) {
        if (record.checkIn && record.checkOut) {
          if (!record.isHalfDay) presentDays++;
          else halfDays++;
        }
        if (record.isLate) lateMarks++;
      }
    });

    leaveData.forEach((leave) => {
      if (leave.status === 'Approved') {
        const from = new Date(leave.fromDate);
        const to = new Date(leave.toDate);
        if (from.getMonth() === currentMonth && from.getFullYear() === currentYear) {
          const days = Math.ceil((to - from) / (1000 * 60 * 60 * 24)) + 1;
          leaveDaysCount += days;
        }
      }
    });

    const totalDays = new Date().getDate();

    document.getElementById('totalDays').textContent = totalDays;
    document.getElementById('presentDays').textContent = presentDays;
    document.getElementById('leaveDays').textContent = leaveDaysCount;
    document.getElementById('lateMarks').textContent = lateMarks;
    document.getElementById('halfDays').textContent = halfDays;

    await updateAttendanceStatus(attendanceData);
  }

  async function updateAttendanceStatus(attendanceData) {
    if (!currentEmployee) return;
    const today = new Date().toDateString();
    const todayData = attendanceData.find((r) => r.date === today);
    let statusHtml = '';
    if (todayData) {
      if (todayData.checkIn && !todayData.checkOut) statusHtml = '<span class="status checked-in">Checked In</span>';
      else if (todayData.checkIn && todayData.checkOut)
        statusHtml = `<span class="status checked-out">Checked Out (${todayData.status || 'Full Day'})</span>`;
      if (todayData.isLate) statusHtml += ' <span class="status" style="background: #fff3cd; color: #856404;">Late Mark</span>';
      if (todayData.isHalfDay) statusHtml += ' <span class="status" style="background: #ffe0b2; color: #e65100;">Half Day</span>';
    } else {
      statusHtml = '<span class="status" style="background: #f8f9fa; color: #6c757d;">Not Marked</span>';
    }
    ['currentStatus', 'attendanceStatus'].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = statusHtml;
    });
  }

  async function checkIn() {
    if (!currentEmployee) return;
    const now = new Date();
    const today = now.toDateString();
    const attendanceObj = {
      empId: currentEmployee,
      date: today,
      checkIn: now.toLocaleTimeString(),
      checkOut: '',
      location: userLocation,
      isLate: now.getHours() > 9 || (now.getHours() === 9 && now.getMinutes() > 0),
      isHalfDay: false,
    };
    const res = await callApi('markAttendance', attendanceObj);
    if (res && res.success) {
      document.getElementById('attendanceMessage').innerHTML = `<div class="alert alert-success">Checked in at ${attendanceObj.checkIn}${
        attendanceObj.isLate ? ' (Late)' : ''
      }</div>`;
      await updateDashboard();
    } else {
      document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Failed to check in</div>';
    }
  }

  async function checkOut() {
    if (!currentEmployee) return;
    const now = new Date();
    const today = now.toDateString();

    const attendanceRes = await callApi('getAttendance', { empId: currentEmployee });
    if (!attendanceRes || !attendanceRes.success) {
      document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Failed to load attendance data</div>';
      return;
    }

    let todayRecord = attendanceRes.attendance.find((r) => r.date === today);
    if (!todayRecord || !todayRecord.checkIn) {
      document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Please check in first!</div>';
      return;
    }
    if (todayRecord.checkOut) {
      document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Already checked out today!</div>';
      return;
    }

    const checkInTime = new Date(today + ' ' + todayRecord.checkIn);
    const diffHours = (now - checkInTime) / (1000 * 60 * 60);

    todayRecord.checkOut = now.toLocaleTimeString();
    todayRecord.checkOutLocation = userLocation;
    todayRecord.isHalfDay = diffHours < 4;
    todayRecord.status = todayRecord.isHalfDay ? 'Half Day' : diffHours < 8 ? 'Short Day' : 'Full Day';

    const markOutObj = {
      empId: currentEmployee,
      date: today,
      checkIn: todayRecord.checkIn,
      checkOut: todayRecord.checkOut,
      location: userLocation,
      isLate: todayRecord.isLate,
      isHalfDay: todayRecord.isHalfDay,
    };

    const res = await callApi('markAttendance', markOutObj);
    if (res && res.success) {
      document.getElementById('attendanceMessage').innerHTML = `<div class="alert alert-success">Checked out at ${markOutObj.checkOut}. Work duration: ${diffHours.toFixed(
        2
      )} hours. Status: ${markOutObj.status}</div>`;
      await updateDashboard();
    } else {
      document.getElementById('attendanceMessage').innerHTML = '<div class="alert alert-error">Failed to check out</div>';
    }
  }

  async function submitLeave() {
    if (!currentEmployee) return;

    const leaveType = document.getElementById('leaveType').value;
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const reason = document.getElementById('leaveReason').value;
    const messageDiv = document.getElementById('leaveMessage');

    if (!fromDate || !toDate || !reason) {
      messageDiv.innerHTML = '<div class="alert alert-error">Please fill all fields</div>';
      return;
    }
    if (new Date(fromDate) > new Date(toDate)) {
      messageDiv.innerHTML = '<div class="alert alert-error">"From Date" cannot be after "To Date"</div>';
      return;
    }

    const leaveRequest = {
      empId: currentEmployee,
      type: leaveType,
      fromDate,
      toDate,
      reason,
    };

    const res = await callApi('applyLeave', leaveRequest);
    if (res && res.success) {
      messageDiv.innerHTML = '<div class="alert alert-success">Leave request submitted successfully!</div>';
      document.getElementById('leaveReason').value = '';
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      await updateDashboard();
    } else {
      messageDiv.innerHTML = '<div class="alert alert-error">Failed to submit leave request</div>';
    }
  }

  // Other existing UI and utility functions (showTab, updateTime, getCurrentLocation, updateLocationDisplay, logout, etc.) remain unchanged and should be included here.

  document.addEventListener('DOMContentLoaded', () => {
    updateTime();
    setInterval(updateTime, 1000);
    getCurrentLocation();
  });
</script>
</body>
</html>
